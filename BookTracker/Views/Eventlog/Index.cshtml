@model BookTracker.ViewModels.EventLog

@{
    ViewBag.Title = "Index";

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<script src="~/Scripts/jquery-3.3.1.min.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.js">s</script>
<script src="~/Content/DataTables/js/jquery.dataTables.min.js"></script>
<script src="~/Content/DataTables/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Scripts/jquery-ui-1.12.1.min.js"></script>
<script src="~/Scripts/moment.min.js"></script>




<html>
<head class="container-fluid">
    <meta name="viewport" content="width=device-width" />
    <title>Users</title>


    <link href="~/Content/DataTables/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/DataTables/css/dataTables.jqueryui.min.css" rel="stylesheet" />
    <script src="~/Scripts/bootstrap.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css">

</head>
<body class="body">
    <div class="row" style="padding-left: 15px">
        <div style="padding: 15px">
            From:
            <input class="form-control datepicker" type="text" id="min" placeholder="From Date" />


        </div>
        <div style="padding: 15px">
            To:
            <input class="form-control datepicker" type="text" placeholder="To Date" id="max" />

        </div>


    </div>
    <div style="margin:0 auto" class="table table-striped table-responsive table-bordered">
        <table id="accountsTable">
            <thead class="thead-dark">
                <tr>
                    <th>Event ID</th>
                    <th>Time Date</th>
                    <th>From Page</th>
                    <th>To Page </th>
                    <th>Journal ID</th>
                    <th>User</th>


                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th>Event ID</th>
                    <th>Time Date</th>
                    <th>From Page</th>
                    <th>To Page </th>
                    <th>Journal ID</th>
                    <th>User</th>


                </tr>
            </tfoot>
        </table>
    </div>
    <div class="modal fade" id="transModal">
        <div class="modal-dialog">
            <div class="modal-content embed-responsive">
                <div class="modal-header">

                    <h4 style="padding-right: 5px">Transactions</h4>
                    <a href="#" class="close text-danger" data-dismiss="modal">&times;</a>
                </div>
                <div class="modal-body">
                    <table id="transDebTable" class="table-condensed" style="margin:auto; width: 100%; border-top: 0; border-bottom: 0;">

                        <thead class="thead">
                            <tr style="text-align: center">
                                <th style="text-align: left">Account</th>
                                <th>Transaction Type</th>
                                <th>Amount</th>

                            </tr>
                        </thead>

                    </table>
                    <table id="transCredTable" class="table-condensed" style="margin:auto; width: 100%; border-top: 0; border-bottom: 0;">

                        <tr style="text-align: center">
                            <th>Account</th>
                            <th>Transaction Type</th>
                            <th>Amount</th>

                        </tr>


                    </table>
                    <table id="filesTable" class="attachTable">
                        <tr>
                            <th>File Name</th>
                            <th>Download</th>
                        </tr>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ledger">
        <div class="modal-dialog embed-responsive" style=" width: 100% !important;">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 style="padding-right: 5px" id="acctTitle"> </h4>
                    <a href="#" class="close text-danger" data-dismiss="modal">&times;</a>
                </div>
                <div class="modal-body">

                    <table id="ledgerTable" class="table-condensed" style="margin:auto; width: 100%; border-top: 0; border-bottom: 0;">

                        <thead class="">

                            <tr>
                                <th>Date </th>
                                <th>Post Reference No.</th>
                                <th>Debit</th>
                                <th> Credit</th>
                            </tr>
                        </thead>
                        <tbody>

                            <tr></tr>

                        </tbody>
                        <tfoot>
                            <tr>
                                <th>
                                </th>
                                <th>
                                </th>
                                <th>
                                </th>
                                <th>
                                </th>
                            </tr>

                        </tfoot>

                    </table>

                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="journalDetails">
        <div class="modal-dialog embed-responsive" style=" width: 100% !important;">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 style="padding-right: 5px" id="jouralTitle">Transactions</h4>
                    <a href="#" class="close text-danger" data-dismiss="modal">&times;</a>
                </div>

                <div class="modal-body">
                    <table id="journalDetailsTable" class="transTable1" style=" width: 100% !important;">

                        <thead class="thead-dark">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Prepared By</th>
                                <th>Approved By</th>

                            </tr>
                        </thead>

                    </table>
                    <table id="transDebTable1" class="transTable1" style=" width: 100% !important;">

                        <thead class="thead-dark">
                            <tr>
                                <th>Account</th>
                                <th>Transaction Type</th>
                                <th>Amount</th>

                            </tr>
                        </thead>

                    </table>
                    <table id="transCredTable1" class="transTable" style=" width: 100% !important;">
                        <tr>
                            <th>Account</th>
                            <th>Transaction Type</th>
                            <th>Amount</th>
                        </tr>


                    </table>

                    <table id="filesTable2" class="attachTable">
                        <tr>
                            <th>File Name</th>
                            <th>Download</th>
                        </tr>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


</body>
</html>
<script>
    $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
            var min = $('#min').datepicker("getDate");
            var max = $('#max').datepicker("getDate");
            var startDate = new Date(data[1]);
            if (min == null && max == null) { return true; }
            if (min == null && startDate <= max) { return true; }
            if (max == null && startDate >= min) { return true; }
            if (startDate <= max && startDate >= min) { return true; }
            return false;
        }
    );

    $(document).ready(function () {
        var otable = $('#accountsTable').DataTable({
            "dom": ' <"search"f><"top"l>rt<"bottom"ip><"clear">',
            "processing": true,
            // "serverSide": true,
            "ajax": {
                "url": '/EventLog/LoadData',
                "type": "POST",
                "datatype": "json",
                "data": "data"
            },
            "columns": [


                //index 0

                { "data": "eventID", "name": "balance", "autoWidth": true },
                {
                    "data": "eventDate",
                    "render": function (d) {
                        return moment(d).format("MM/DD/YYYY HH:MM:SS");;
                    },
                    "name": "dateCreated", "autoWidth": true
                },//i,//index 4
                {
                    "data": "fromPage", "render": function (data) {

                        return "<a href='#' class='' onclick='ledgerModal(" + data + ")'></i>" + data + "</a>";
                    },

                    "name": "totalDebits", "autoWidth": true
                },//index 5
                //index 6
                { "data": "toPage", "name": "acctStateID", "autoWidth": true },
                {
                    "data": "journalID", "render": function (data) {

                        return "<a href='#' class='' onclick='showDetails(" + data + ")'></i>" + data + "</a>";
                    },
                    "autoWidth": true
                },//index 7
                { "data": "userID", "name": "comments", "autoWidth": true },
                //index 8

            ]


        });

        $("#min").datepicker({ onSelect: function () { otable.draw(); }, changeMonth: true, changeYear: true });
        $("#max").datepicker({ onSelect: function () { otable.draw(); }, changeMonth: true, changeYear: true });
      
        function sqlToJsDate(sqlDate) {
            //sqlDate in SQL DATETIME format ("yyyy-mm-dd hh:mm:ss.ms")
            var sqlDateArr1 = sqlDate.split("-");
            //format of sqlDateArr1[] = ['yyyy','mm','dd hh:mm:ms']
            var sYear = sqlDateArr1[0];
            var sMonth = (Number(sqlDateArr1[1]) - 1).toString();
            var sqlDateArr2 = sqlDateArr1[2].split(" ");
            //format of sqlDateArr2[] = ['dd', 'hh:mm:ss.ms']
            var sDay = sqlDateArr2[0];
            var sqlDateArr3 = sqlDateArr2[1].split(":");
            //format of sqlDateArr3[] = ['hh','mm','ss.ms']
            var sHour = sqlDateArr3[0];
            var sMinute = sqlDateArr3[1];
            var sqlDateArr4 = sqlDateArr3[2].split(".");
            //format of sqlDateArr4[] = ['ss','ms']
            var sSecond = sqlDateArr4[0];
            var sMillisecond = sqlDateArr4[1];

            return new Date(sYear, sMonth, sDay, sHour, sMinute, sSecond, sMillisecond);
        }




    });
    function showDetails(journal) {

        $("#transModal").modal();
        // var url = "/Accountant/LoadTransaction?journalId=" + data;
        // otable.bDestroy();


        var transDebTable = $('#transDebTable').DataTable({
            processing: false,


            "ajax": {

                "url": "/Journal/LoadTransactionDeb?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "Invalid Journal!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [
                { "data": "acctName", "name": "acctName" },//index 1
                { "data": "transactionType", "name": "transactionType" },//index 2
                {
                    "data": "transactionAmount",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$ '),
                    "name": "transactionAmount",

                },

            ],

            "columnDefs": [
                { className: "text-right", "targets": [2] },
                { className: "text-right", "targets": [0] },
                { className: "text-left", "targets": [1] },
            ]


        });
        var transCredTable = $('#transCredTable').DataTable({
            processing: false,

            "ajax": {
                "url": "/Journal/LoadTransactionCred?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "Invalid Journal!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [

                { "data": "acctName", "name": "acctName" },//index 1
                { "data": "transactionType", "name": "transactionType" },//index 2
                {
                    "data": "transactionAmount",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$ '),
                    "name": "transactionAmount",

                },

            ],

            "columnDefs": [
                { className: "text-right", "targets": [2] },
                { className: "text-right", "targets": [0, 1] }
            ]


        });
        var filesTable = $('#filesTable').DataTable({
            "ajax": {

                "url": "/Blob/JournalFiles?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "There are no files!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,

            "rowID": "ActualFileName",

            "columns": [
                {
                    "data": "FileNameWithoutExt",
                    "name": "FileNameWithoutExt",
                    "autoWidth": true
                },
                {
                    "data": "ActualFileName",
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a href="https://booktrackerfiles.blob.core.windows.net/journal/' + journal + '/' + data + '" download>Download &#xf019;</a>'
                        }
                        return data;
                    }
                },
            ],


            "columnDefs": [
                { className: "text-right", "targets": 1 }
            ]
        })

        //transTable.destroy();

    }
    function ledgerModal(data) {
        $("#ledger").modal();
        $("#acctTitle").html("Account: " + data);
        var ledgerTable = $('#ledgerTable').DataTable({
            //processing: false,
            "ajax": {

                "url": "/Journal/LoadLedger?acctNo=" + data,
                "type": "POST",
                "datatype": "json",
                "data": "data"
            },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [

                {
                    "data": "approvalDate",
                    "render": function (d) {
                        return moment(d).format("MM/DD/YYYY");
                    }, "name": "approvalDate", "autoWidth": true
                },
                {
                    "data": "journalID",  // this is only difference, link here, accountant no link.
                    "render": function (data, type) {
                        if (type == 'display') {
                            return "<a href='#' onclick='journalModal(" + data + ")'>" + data + " </a>";
                        }
                        return data;
                    },

                    "name": "acctName", "autoWidth": true
                },

                {
                    "data": "debits",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$'),
                    "name": "debits",
                    "autoWidth": true,
                },
                {
                    "data": "credits",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$'),
                    "name": "credits",
                    "autoWidth": true,
                },

            ],
            "columnDefs": [
                { className: "text-right", "targets": [2, 3] },
                { className: "text-center", "targets": [0, 1] },
                { searchable: false, targets: [0, 1, 2, 3] },
                { orderable: false, targets: [0, 1, 2, 3] },
                { orderFixed: [1, ''] }

            ],

            footerCallback: function (row, data) {
                var api = this.api(), data;
                var numFormat = $.fn.dataTable.render.number(',', '.', 2, '$').display;
                var intVal = function (i) {
                    return i
                };

                var debtTotal = api
                    .column(2)
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);

                var credTotal = api
                    .column(3)
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);
                $(api.column(0).footer()).html('Balance');
                $(api.column(2).footer()).html('');
                $(api.column(2).footer()).css('text-align', 'right');
                $(api.column(3).footer()).html(numFormat((debtTotal - credTotal)));

                $(api.column(3).footer()).css('text-align', 'right');

            },

        });
    }

    function journalModal(journal) {
        $("#journalDetails").modal();
        $("#jouralTitle").html("Journal #: " + journal);
        var journalDetails = $('#journalDetailsTable').DataTable({
            processing: false,
            "ajax": {

                "url": "/Journal/LoadJournalDetails?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [
                {
                    "data": "datePrepared",
                    "render": function (d) {
                        return moment(d).format("MM/DD/YYYY");
                    },
                    "name": "acctName", "autoWidth": true
                },//index 1
                { "data": "journalType", "name": "transactionType", "autoWidth": true },
                { "data": "preparorID", "name": "transactionType", "autoWidth": true },
                { "data": "approverID", "name": "transactionType", "autoWidth": true },//index 2


            ],

            "columnDefs": [
                { className: "text-right", "targets": [2, 3] }
            ]


        });
        var transDebTable = $('#transDebTable1').DataTable({
            processing: false,


            "ajax": {

                "url": "/Journal/LoadTransactionDeb?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "Invalid Journal!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [
                { "data": "acctName", "name": "acctName", "autoWidth": true },//index 1
                { "data": "transactionType", "name": "transactionType", "autoWidth": true },//index 2
                {
                    "data": "transactionAmount",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$ '),
                    "name": "transactionAmount",
                    "autoWidth": true,
                },

            ],

            "columnDefs": [
                { className: "text-right", "targets": 2 }
            ]


        });
        var transCredTable = $('#transCredTable1').DataTable({
            processing: false,

            "ajax": {
                "url": "/Journal/LoadTransactionCred?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "Invalid Journal!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,


            "columns": [

                { "data": "acctName", "name": "acctName", "autoWidth": true },//index 1
                { "data": "transactionType", "name": "transactionType", "autoWidth": true },//index 2
                {
                    "data": "transactionAmount",
                    "render": $.fn.dataTable.render.number(',', '.', 2, '$ '),
                    "name": "transactionAmount",
                    "autoWidth": true,
                },

            ],

            "columnDefs": [
                { className: "text-right", "targets": [2] },
                { className: "text-center", "targets": [0, 1] }
            ]


        });

        var filesTable = $('#filesTable2').DataTable({
            "ajax": {

                "url": "/Blob/JournalFiles?journalId=" + journal,
                "type": "GET",
                "datatype": "json",
                "data": "data"
            },
            "language": { "emptyTable": "There are no files!" },
            "destroy": true,
            "searching": false,
            "paging": false,
            "info": false,
            "sort": false,

            "rowID": "ActualFileName",

            "columns": [
                {
                    "data": "FileNameWithoutExt",
                    "name": "FileNameWithoutExt",
                    "autoWidth": true
                },
                {
                    "data": "ActualFileName",
                    "render": function (data, type, row, meta) {
                        if (type === 'display') {
                            data = '<a href="https://booktrackerfiles.blob.core.windows.net/journal/' + journal + '/' + data + '" download>Download &#xf019;</a>'
                        }
                        return data;
                    }
                },
            ],


            "columnDefs": [
                { className: "text-right", "targets": 1 }
            ]
        })
    }
</script>